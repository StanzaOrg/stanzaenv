#use-added-syntax(tests)
defpackage stanzaenv/test-e2e :
  import core
  import collections
  import zip

deftest test-stanzaenv-contents :

  ;Reset the testscratch folder.
  val root = "testscratch"
  delete-recursive(root)
  create-dir-recursive(root)

  ;Unzip the zip file contents. 
  val zip = "build/outputs/stanzaenv-osx.zip"
  extract(ZipArchive(zip), root)

  ;List of expected files in .zip archive.
  val expected-files = [
    "bin/stanzaenv"]
    
  for file in expected-files do :
    val fullpath = string-join([root "/" file])
    #ASSERT(file-exists?(fullpath))
    #ASSERT(file-type(fullpath) is RegularFileType)

defn try-fresh-install (prompts:String) :
  ;Reset scratch directory.
  delete-recursive("testscratch")

  ;Create a scratch directory for testing.
  create-dir-recursive("testscratch")

  ;Here is the mock HOME directory.
  create-dir-recursive("testscratch/patrick")

  ;Here are questions to the prompts.
  spit("testscratch/prompts.txt", prompts)

  ;Run the installation command.
  val exe = "build/stanzaenv-osx"
  call-system(exe,
              [exe, "install"]
              false,
              ["HOME" => resolve-path!("testscratch/patrick")
               "ENABLE_DEBUGENV" => ""
               "INTERCEPT_STANZA_URL" => "/Users/patricksli/Docs/Programming/stanzasite/resources/stanza"
               "INTERCEPT_STANZAENV_URL" => resolve-path!("build/outputs")
               "INTERCEPT_PROMPTS" => "testscratch/prompts.txt"])

;deftest test-stanzaenv-install :
;let :
;  val prompts = \<STR>
;    "installed in" => ""
;    "system PATH" => "No"
;    "initial version of Stanza" => "0.17.4"
;  <STR>
;  try-fresh-install(prompts)

;let :
;  val prompts = \<STR>
;    "installed in" => ""
;    "system PATH" => "No"
;    "initial version of Stanza" => "0.17.50"
;  <STR>
;  try-fresh-install(prompts)

let :
  val prompts = \<STR>
    "installed in" => "testscratch/custom"
    "system PATH" => "No"
    "STANZAENV_DIR" => "Yes"
    "initial version of Stanza" => "0.17.4"
  <STR>
  try-fresh-install(prompts)